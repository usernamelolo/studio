<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –ö–æ–Ω—Ç–µ–Ω—Ç–∞</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { background: #f8fafc; font-family: system-ui; }
    .header { background: linear-gradient(90deg, #4f46e5, #7c3aed); }
    .tab-active { background: #4f46e5; color: white; font-weight: 700; }
    .card { background: white; border: 2px solid #e0e7ff; box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.05); }
    video, img { border-radius: 16px; box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1); }
  </style>
</head>
<body class="text-gray-900 min-h-screen pb-20">
  <!-- –õ–û–ì–ò–ù –¢–û–õ–¨–ö–û –ü–û –ü–ê–†–û–õ–Æ -->
  <div id="login-screen" class="min-h-screen flex items-center justify-center bg-gradient-to-br from-indigo-50 to-purple-50">
    <div class="bg-white p-12 rounded-3xl shadow-2xl max-w-md w-full">
      <h1 class="text-5xl font-bold text-center mb-10 text-indigo-700">AI –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –ö–æ–Ω—Ç–µ–Ω—Ç–∞</h1>
      <div class="space-y-6">
        <div>
          <label class="block text-sm font-medium text-gray-600 mb-2">–ü–∞—Ä–æ–ª—å –¥–æ—Å—Ç—É–ø–∞</label>
          <input id="password" type="password" class="w-full border-2 border-indigo-200 rounded-2xl px-6 py-4 text-lg focus:border-indigo-500" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å">
        </div>
        <button onclick="login()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white text-2xl font-semibold py-7 rounded-3xl transition">–í–æ–π—Ç–∏</button>
      </div>
    </div>
  </div>

  <!-- –ì–õ–ê–í–ù–ê–Ø –°–¢–†–ê–ù–ò–¶–ê -->
  <div id="main-content" class="hidden">
    <div class="max-w-7xl mx-auto p-6">
      <header class="header text-white text-center py-12 rounded-3xl mb-12 flex justify-between items-center px-12">
        <h1 class="text-5xl font-bold tracking-tight">AI –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –ö–æ–Ω—Ç–µ–Ω—Ç–∞</h1>
        <button onclick="logout()" class="bg-white/20 hover:bg-white/30 text-white px-8 py-3 rounded-2xl text-lg transition">–í—ã–π—Ç–∏</button>
      </header>

      <div class="flex justify-center mb-10 border-b-4 border-indigo-200">
        <button onclick="switchTab(0)" id="tab0" class="tab-active px-14 py-5 text-2xl rounded-t-3xl">üé• –í–∏–¥–µ–æ –∏–∑ —Ñ–æ—Ç–æ</button>
        <button onclick="switchTab(1)" id="tab1" class="px-14 py-5 text-2xl rounded-t-3xl">üñºÔ∏è –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–∑ —Ñ–æ—Ç–æ</button>
      </div>

      <!-- –í–ò–î–ï–û –ò–ó –§–û–¢–û -->
      <div id="section-video" class="card p-10 rounded-3xl">
        <h2 class="text-4xl font-semibold mb-8 text-indigo-700">üé• –í–∏–¥–µ–æ –∏–∑ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–≥–æ —Ñ–æ—Ç–æ</h2>
        <div class="max-w-2xl mx-auto">
          <input type="file" id="video-image-upload" accept="image/*" class="block w-full border-2 border-dashed border-indigo-300 rounded-2xl p-8 text-center cursor-pointer mb-6">
          <textarea id="video-image-prompt" rows="4" class="w-full border-2 border-indigo-200 rounded-2xl p-6 text-lg" placeholder="–û–ø–∏—à–∏—Ç–µ –∂–µ–ª–∞–µ–º—É—é –∞–Ω–∏–º–∞—Ü–∏—é..."></textarea>
          <div class="grid grid-cols-3 gap-4 mt-6">
            <div><label class="block text-sm mb-1 text-gray-600">–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å</label><select id="duration" class="w-full border border-indigo-200 rounded-xl p-3"><option value="8" selected>8 —Å–µ–∫—É–Ω–¥</option><option value="10">10 —Å–µ–∫—É–Ω–¥</option><option value="15">15 —Å–µ–∫—É–Ω–¥</option></select></div>
            <div><label class="block text-sm mb-1 text-gray-600">–§–æ—Ä–º–∞—Ç</label><select id="aspect" class="w-full border border-indigo-200 rounded-xl p-3"><option value="16:9">16:9</option><option value="9:16" selected>9:16</option><option value="1:1">1:1</option></select></div>
            <div><label class="block text-sm mb-1 text-gray-600">–ö–∞—á–µ—Å—Ç–≤–æ</label><select id="resolution" class="w-full border border-indigo-200 rounded-xl p-3"><option value="720p">720p</option><option value="480p" selected>480p</option></select></div>
          </div>
          <button onclick="generateVideo()" class="mt-10 w-full bg-indigo-600 hover:bg-indigo-700 text-white text-2xl font-semibold py-7 rounded-3xl transition">–°–æ–∑–¥–∞—Ç—å –≤–∏–¥–µ–æ</button>
        </div>
        <div id="video-result" class="mt-12 hidden">
          <div id="video-status" class="text-center text-xl mb-6 text-gray-700"></div>
          <video id="video-player" controls class="w-full max-w-4xl mx-auto"></video>
          <div class="flex gap-4 justify-center mt-6">
            <button onclick="downloadVideo()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-12 py-4 rounded-2xl text-lg">–°–∫–∞—á–∞—Ç—å –≤–∏–¥–µ–æ</button>
            <button onclick="stopVideoGeneration()" id="stop-btn" class="bg-red-600 hover:bg-red-700 text-white px-8 py-4 rounded-2xl text-lg">–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≥–µ–Ω–µ—Ä–∞—Ü–∏—é</button>
          </div>
        </div>
        <div id="video-debug" class="mt-8 bg-slate-900 text-emerald-300 p-6 rounded-2xl font-mono text-sm overflow-auto max-h-96"></div>
      </div>

      <!-- –ò–ó–û–ë–†–ê–ñ–ï–ù–ò–Ø –ò–ó –§–û–¢–û -->
      <div id="section-image" class="card p-10 rounded-3xl hidden">
        <h2 class="text-4xl font-semibold mb-8 text-indigo-700">üñºÔ∏è –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–∑ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–≥–æ —Ñ–æ—Ç–æ</h2>
        <div class="max-w-2xl mx-auto">
          <input type="file" id="main-edit-upload" accept="image/*" class="block w-full border-2 border-dashed border-indigo-300 rounded-2xl p-8 text-center cursor-pointer mb-6">
          <textarea id="edit-prompt" rows="4" class="w-full border-2 border-indigo-200 rounded-2xl p-6 text-lg" placeholder="–û–ø–∏—à–∏—Ç–µ –∂–µ–ª–∞–µ–º—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è..."></textarea>
          <button onclick="editImage()" class="mt-8 w-full bg-indigo-600 hover:bg-indigo-700 text-white text-2xl font-semibold py-7 rounded-3xl transition">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å 2 –≤–∞—Ä–∏–∞–Ω—Ç–∞</button>
        </div>

        <div id="image-result" class="mt-12 hidden grid md:grid-cols-2 gap-8">
          <div>
            <p class="text-sm font-medium text-gray-600 mb-2 text-center">–í–∞—Ä–∏–∞–Ω—Ç 1</p>
            <img id="variant1" class="w-full rounded-3xl" alt="–í–∞—Ä–∏–∞–Ω—Ç 1">
            <button onclick="downloadImage(1)" class="mt-4 w-full bg-indigo-600 hover:bg-indigo-700 text-white py-3 rounded-2xl">–°–∫–∞—á–∞—Ç—å –≤–∞—Ä–∏–∞–Ω—Ç 1</button>
          </div>
          <div>
            <p class="text-sm font-medium text-gray-600 mb-2 text-center">–í–∞—Ä–∏–∞–Ω—Ç 2</p>
            <img id="variant2" class="w-full rounded-3xl" alt="–í–∞—Ä–∏–∞–Ω—Ç 2">
            <button onclick="downloadImage(2)" class="mt-4 w-full bg-indigo-600 hover:bg-indigo-700 text-white py-3 rounded-2xl">–°–∫–∞—á–∞—Ç—å –≤–∞—Ä–∏–∞–Ω—Ç 2</button>
          </div>
        </div>

        <div id="debug" class="mt-12 bg-slate-900 text-emerald-300 p-6 rounded-2xl font-mono text-sm overflow-auto max-h-96"></div>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = "/api/proxy";
    let videoInterval = null;
    let currentVideoUrl = '';

    let currentTab = 0;
    function switchTab(n) {
      currentTab = n;
      document.getElementById('section-video').classList.toggle('hidden', n !== 0);
      document.getElementById('section-image').classList.toggle('hidden', n !== 1);
      document.getElementById('tab0').classList.toggle('tab-active', n === 0);
      document.getElementById('tab1').classList.toggle('tab-active', n === 1);
    }

    async function login() {
      const password = document.getElementById('password').value.trim();
      if (!password) return alert('–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å');

      try {
        const res = await fetch('/api/auth', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ password })
        });
        const data = await res.json();

        if (data.success) {
          document.getElementById('login-screen').classList.add('hidden');
          document.getElementById('main-content').classList.remove('hidden');
          switchTab(0);
        } else {
          alert('–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å');
        }
      } catch (e) {
        alert('–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ ‚Äî –ø—Ä–æ–≤–µ—Ä—å, —á—Ç–æ api/auth.js –∑–∞–≥—Ä—É–∂–µ–Ω –∏ SITE_PASSWORD –Ω–∞—Å—Ç—Ä–æ–µ–Ω –≤ Vercel');
      }
    }

    function logout() {
      document.getElementById('main-content').classList.add('hidden');
      document.getElementById('login-screen').classList.remove('hidden');
      document.getElementById('password').value = '';
    }

    async function apiFetch(endpoint, options = {}) {
      return fetch(API_BASE + endpoint, { ...options, headers: { ...options.headers, 'Content-Type': 'application/json' } });
    }

    async function fileToBase64(file) {
      return new Promise(resolve => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.readAsDataURL(file);
      });
    }

    function downloadImage(num) {
      const img = document.getElementById('variant' + num);
      if (!img.src) return alert('–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–µ –≥–æ—Ç–æ–≤–æ');
      const a = document.createElement('a');
      a.href = img.src;
      a.download = `variant-${num}-${Date.now()}.jpg`;
      a.click();
    }

    function stopVideoGeneration() {
      if (videoInterval) clearInterval(videoInterval);
      videoInterval = null;
      document.getElementById('video-status').textContent = '–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞';
      document.getElementById('video-debug').innerHTML += 'üõë –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º\n';
    }

    async function editImage() {
      const file = document.getElementById('main-edit-upload').files[0];
      if (!file) return alert('–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–æ—Ç–æ');
      const prompt = document.getElementById('edit-prompt').value || "–£–ª—É—á—à–∏—Ç—å –∫–∞—á–µ—Å—Ç–≤–æ";
      const debug = document.getElementById('debug');
      debug.innerHTML = '–û—Ç–ø—Ä–∞–≤–∫–∞ –¥–≤—É—Ö –æ—Ç–¥–µ–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤...\n';
      document.getElementById('image-result').classList.add('hidden');

      try {
        const base64Main = await fileToBase64(file);
        const seed1 = Math.floor(Math.random() * 2147483647);
        const seed2 = Math.floor(Math.random() * 2147483647);

        const res1 = await apiFetch('/v1/images/edits', { method: 'POST', body: JSON.stringify({ model: "grok-imagine-image", prompt, image: { url: base64Main }, n: 1, response_format: "b64_json", seed: seed1 }) });
        const data1 = await res1.json();
        debug.innerHTML += `–í–∞—Ä–∏–∞–Ω—Ç 1 —Å—Ç–∞—Ç—É—Å: ${res1.status}\n` + JSON.stringify(data1, null, 2) + '\n\n';

        const res2 = await apiFetch('/v1/images/edits', { method: 'POST', body: JSON.stringify({ model: "grok-imagine-image", prompt, image: { url: base64Main }, n: 1, response_format: "b64_json", seed: seed2 }) });
        const data2 = await res2.json();
        debug.innerHTML += `–í–∞—Ä–∏–∞–Ω—Ç 2 —Å—Ç–∞—Ç—É—Å: ${res2.status}\n` + JSON.stringify(data2, null, 2) + '\n\n';

        if (data1.data && data1.data[0] && data2.data && data2.data[0]) {
          document.getElementById('variant1').src = `data:image/jpeg;base64,${data1.data[0].b64_json}`;
          document.getElementById('variant2').src = `data:image/jpeg;base64,${data2.data[0].b64_json}`;
          document.getElementById('image-result').classList.remove('hidden');
        }
      } catch (e) {
        debug.innerHTML += '‚ùå ' + e.message;
      }
    }

    async function generateVideo() {
      const file = document.getElementById('video-image-upload').files[0];
      if (!file) return alert('–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–æ—Ç–æ');

      const statusEl = document.getElementById('video-status');
      const resultDiv = document.getElementById('video-result');
      const debug = document.getElementById('video-debug');
      const stopBtn = document.getElementById('stop-btn');

      resultDiv.classList.remove('hidden');
      stopBtn.style.display = 'inline-block';
      statusEl.textContent = '–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –≤–∏–¥–µ–æ... (20‚Äì60 —Å–µ–∫—É–Ω–¥)';
      debug.innerHTML = '–û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞...\n';

      if (videoInterval) clearInterval(videoInterval);

      try {
        const base64Image = await fileToBase64(file);
        const body = {
          model: "grok-imagine-video",
          prompt: document.getElementById('video-image-prompt').value || "–ê–Ω–∏–º–∏—Ä–æ–≤–∞—Ç—å —Å—Ü–µ–Ω—É",
          duration: parseInt(document.getElementById('duration').value),
          aspect_ratio: document.getElementById('aspect').value,
          resolution: document.getElementById('resolution').value,
          image: { url: base64Image },
          seed: Math.floor(Math.random() * 2147483647)
        };

        const res = await apiFetch('/v1/videos/generations', { method: 'POST', body: JSON.stringify(body) });
        const data = await res.json();
        debug.innerHTML += `–°—Ç–∞—Ç—É—Å: ${res.status}\n` + JSON.stringify(data, null, 2) + '\n\n';

        const requestId = data.request_id || data.id;
        let attempts = 0;
        let failedAttempts = 0;

        videoInterval = setInterval(async () => {
          attempts++;
          const statusRes = await apiFetch(`/v1/videos/${requestId}`);
          const statusData = await statusRes.json();
          debug.innerHTML += `Polling #${attempts}: ${JSON.stringify(statusData)}\n`;

          let videoUrl = null;
          if (statusData.video && statusData.video.url) videoUrl = statusData.video.url;
          else if (statusData.url) videoUrl = statusData.url;

          if (videoUrl && videoUrl.includes('vidgen.x.ai')) {
            clearInterval(videoInterval);
            videoInterval = null;
            currentVideoUrl = videoUrl;
            const player = document.getElementById('video-player');
            player.src = currentVideoUrl;
            player.load();
            statusEl.textContent = '–ì–æ—Ç–æ–≤–æ!';
            debug.innerHTML += '‚úÖ –í–∏–¥–µ–æ –≥–æ—Ç–æ–≤–æ –∏ –∑–∞–≥—Ä—É–∂–µ–Ω–æ –≤ –ø–ª–µ–µ—Ä!';
            return;
          }

          const isModerationReject = (statusData.error && statusData.error.includes('content moderation')) || (statusData.error && statusData.error.includes('rejected')) || statusData.status === 'failed';

          if (isModerationReject) {
            failedAttempts++;
            if (failedAttempts >= 5) {
              clearInterval(videoInterval);
              videoInterval = null;
              statusEl.textContent = '–í–∏–¥–µ–æ –æ—Ç–∫–ª–æ–Ω–µ–Ω–æ –º–æ–¥–µ—Ä–∞—Ü–∏–µ–π –ø–æ—Å–ª–µ 5 –ø–æ–ø—ã—Ç–æ–∫';
              debug.innerHTML += '‚ùå –í–∏–¥–µ–æ –æ—Ç–∫–ª–æ–Ω–µ–Ω–æ –º–æ–¥–µ—Ä–∞—Ü–∏–µ–π –ø–æ—Å–ª–µ 5 –ø–æ–ø—ã—Ç–æ–∫\n';
              return;
            }
          }

          if (attempts >= 40) {
            clearInterval(videoInterval);
            videoInterval = null;
            statusEl.textContent = '–ü—Ä–µ–≤—ã—à–µ–Ω–æ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è';
            debug.innerHTML += '‚ùå –ü—Ä–µ–≤—ã—à–µ–Ω–æ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è\n';
          }
        }, 3000);
      } catch (e) {
        statusEl.textContent = '–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏';
        debug.innerHTML += '‚ùå –û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏: ' + e.message;
      }
    }

    function downloadVideo() {
      if (!currentVideoUrl) return alert('–í–∏–¥–µ–æ –µ—â—ë –Ω–µ –≥–æ—Ç–æ–≤–æ');
      const a = document.createElement('a');
      a.href = currentVideoUrl;
      a.download = `video-${Date.now()}.mp4`;
      a.click();
    }

    switchTab(0);
  </script>
</body>
</html>
