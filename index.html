
    function displayImages(images, isEdit = false) {
      const gallery = isEdit ? document.getElementById('edited-gallery') : document.getElementById('image-gallery');
      if (!isEdit) gallery.innerHTML = '';
      images.forEach(img => {
        const url = img.url || '';
        const previewSrc = `https://images.weserv.nl/?url=${encodeURIComponent(url)}&w=800`;
        const div = document.createElement('div');
        div.className = 'relative group';
        div.innerHTML = `
          <img src="\( {previewSrc}" class="w-full cursor-pointer rounded-3xl" onclick="window.open(' \){url}', '_blank')">
          <button onclick="downloadImage('${url}')" class="absolute bottom-4 right-4 bg-white/90 px-6 py-2 rounded-2xl text-sm hover:bg-indigo-600 hover:text-white transition">Скачать</button>
        `;
        gallery.appendChild(div);
      });
    }

    function downloadImage(url) {
      if (!url) return alert('Нет ссылки');
      const a = document.createElement('a');
      a.href = url;
      a.download = `adult-image-${Date.now()}.jpg`;
      a.click();
    }

    async function generateImages() {
      const prompt = document.getElementById('image-prompt').value.trim();
      if (!prompt) return alert('Введите описание');
      const debug = document.getElementById('debug');
      debug.innerHTML = 'Отправка запроса...\n';

      try {
        const res = await apiFetch('/v1/images/generations', {
          method: 'POST',
          body: JSON.stringify({ model: "grok-imagine-image", prompt, n: 4, response_format: "url", seed: Math.floor(Math.random() * 2147483647) })
        });
        const data = await res.json();
        debug.innerHTML += `Статус: ${res.status}\n\n` + JSON.stringify(data, null, 2) + '\n\n';
        if (data.data && data.data.length > 0) displayImages(data.data);
      } catch (e) {
        debug.innerHTML += '❌ ' + e.message;
      }
    }

    async function editImage() {
      const mainFile = document.getElementById('main-edit-upload').files[0];
      if (!mainFile) return alert('Загрузите основное фото');
      const prompt = document.getElementById('edit-prompt').value || "Сделать более реалистичным";
      const debug = document.getElementById('debug');
      debug.innerHTML = 'Отправка запроса на редактирование (4 варианта)...\n';

      // Показываем оригинал
      const originalUrl = URL.createObjectURL(mainFile);
      document.getElementById('original-preview').src = originalUrl;
      document.getElementById('edit-result').classList.remove('hidden');
      document.getElementById('edited-gallery').innerHTML = '';

      try {
        const base64Main = await fileToBase64(mainFile);
        const res = await apiFetch('/v1/images/edits', {
          method: 'POST',
          body: JSON.stringify({
            model: "grok-imagine-image",
            prompt: prompt,
            image: { url: base64Main },
            n: 4,
            response_format: "url",
            seed: Math.floor(Math.random() * 2147483647)
          })
        });

        const data = await res.json();
        debug.innerHTML += `Статус: ${res.status}\n\n` + JSON.stringify(data, null, 2) + '\n\n';

        if (data.data && data.data.length > 0) {
          displayImages(data.data, true);
          debug.innerHTML += '✅ 4 варианта редактирования получены!';
        } else {
          debug.innerHTML += '❌ Нет вариантов';
        }
      } catch (e) {
        debug.innerHTML += '❌ ' + e.message;
      }
    }

    switchTab(0);
  </script>
</body>
</html>
